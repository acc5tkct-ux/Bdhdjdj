name: ğŸš€ SERVER ngancute

on:
  workflow_dispatch:
    # ... (Pháº§n chá»n thá»i gian cháº¡y) ...
    inputs:
      duration:
        description: 'Thá»i gian bÃªn nhau (ngancute)'
        required: false
        default: '1_Giá»_30_PhÃºt_(90m)'
        type: choice
        options:
          - '30_PhÃºt_(30m)'
          - '1_Giá»_(60m)'
          - '1_Giá»_30_PhÃºt_(90m)'
          - '2_Giá»_(120m)'
          - '3_Giá»_(180m)'
          - '4_Giá»_(240m)'
          - '6_Giá»_(360m)'

jobs:
  Ngancute-VPS:
    runs-on: windows-latest
    steps:
      # 1. Táº O USER & PASS
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N NGANCUTE
        run: |
          # ... (Táº¡o user 'ngancute' vÃ  máº­t kháº©u ngáº«u nhiÃªn an toÃ n) ...
          $pw = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_})
          $securePass = ConvertTo-SecureString $pw -AsPlainText -Force
          New-LocalUser -Name "ngancute" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "ngancute"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ngancute"
          echo "RDP_PASS=$pw" >> $env:GITHUB_ENV

      # 2. CÃ€I Äáº¶T VÃ€ KHá»I Táº O NGROK
      - name: ğŸŒ Táº O Äá»ŠA CHá»ˆ IP (NGROK)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if (-not $env:NGROK_AUTH_TOKEN) { Write-Error "âŒ ChÆ°a nháº­p NGROK_AUTH_TOKEN vÃ o Secrets!"; exit 1 }
          # Táº£i, giáº£i nÃ©n vÃ  xÃ¡c thá»±c Ngrok báº±ng Secret Key
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip
          .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          # Cháº¡y Tunnel TCP káº¿t ná»‘i vá»›i cá»•ng RDP (3389)
          Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389"
          Start-Sleep -Seconds 5
          # Láº¥y Ä‘á»‹a chá»‰ cÃ´ng khai vÃ  lÆ°u vÃ o biáº¿n SERVER_IP
          $tunnel = Invoke-RestMethod http://localhost:4040/api/tunnels
          $publicUrl = $tunnel.tunnels[0].public_url
          $address = $publicUrl -replace "tcp://", ""
          echo "SERVER_IP=$address" >> $env:GITHUB_ENV

      # 3. KÃCH HOáº T RDP & HIá»‚N THá»Š Káº¾T Ná»I
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          # Má»Ÿ cá»•ng RDP trÃªn Firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Hiá»ƒn thá»‹ thÃ´ng tin
          Write-Host "ğŸ”— IP Address:  $env:SERVER_IP"
          Write-Host "ğŸ‘¤ Username:    ngancute"
          Write-Host "ğŸ” Password:    $env:RDP_PASS"

      # 4. TREO MÃY (KEEP ALIVE)
      - name: â³ DUY TRÃŒ SERVER
        run: |
          $seconds = [int]$env:MINUTES * 60
          # ... (Loop Ä‘áº¿m ngÆ°á»£c Ä‘á»ƒ giá»¯ Runner khÃ´ng bá»‹ ngáº¯t káº¿t ná»‘i) ...
          $end = (Get-Date).AddSeconds($seconds)
          while ((Get-Date) -lt $end) {
              $remaining = New-TimeSpan -Start (Get-Date) -End $end
              Write-Host "`rğŸ’“ Ngancute cÃ²n sá»‘ng: $($remaining.Hours):$($remaining.Minutes):$($remaining.Seconds) " -NoNewline
              Start-Sleep -Seconds 5
          }
          
