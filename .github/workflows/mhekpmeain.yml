name: ğŸš€ SERVER ngancute (Finalized)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Thá»i gian bÃªn nhau (ngancute)'
        required: false
        default: '1_Giá»_30_PhÃºt_(90m)'
        type: choice
        options:
          - '30_PhÃºt_(30m)'
          - '1_Giá»_(60m)'
          - '1_Giá»_30_PhÃºt_(90m)'
          - '2_Giá»_(120m)'
          - '3_Giá»_(180m)'
          - '4_Giá»_(240m)'
          - '5_Giá»_(300m)'
          - '6_Giá»_(360m)'

jobs:
  Ngancute-VPS:
    runs-on: windows-latest
    steps:
      # 1. KHá»I Táº O
      - name: KHá»I Táº O NGANCUTE
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001 > $null
          Write-Host "`nğŸ’– SERVER NGANCUTE ÄANG KHá»I Äá»˜NG..." -ForegroundColor Magenta

      # 2. Táº O USER NGANCUTE (FIXED)
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N NGANCUTE
        shell: powershell
        run: |
          Write-Host "ğŸ‘¤ Äang táº¡o user ngancute..." -ForegroundColor Yellow
          
          # HÃ m táº¡o máº­t kháº©u ngáº«u nhiÃªn máº¡nh
          $pw = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_})
          $securePass = ConvertTo-SecureString $pw -AsPlainText -Force
          
          # FIX: Äáº£m báº£o Ä‘á»‘i sá»‘ -Password Ä‘Æ°á»£c cung cáº¥p chÃ­nh xÃ¡c
          Remove-LocalUser -Name "ngancute" -ErrorAction SilentlyContinue
          New-LocalUser -Name "ngancute" -Password $securePass -AccountNeverExpires -Description "Server Ngancute"
          
          Add-LocalGroupMember -Group "Administrators" -Member "ngancute"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ngancute"
          
          echo "RDP_PASS=$pw" >> $env:GITHUB_ENV
          Write-Host "âœ… User ngancute sáºµn sÃ ng." -ForegroundColor Green

      # 3. CÃ€I Äáº¶T NGROK VÃ€ Táº O IP (FIXED)
      - name: ğŸŒ Táº O Äá»ŠA CHá»ˆ IP (NGROK)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if (-not $env:NGROK_AUTH_TOKEN) { Write-Error "âŒ ChÆ°a nháº­p NGROK_AUTH_TOKEN vÃ o Secrets!"; exit 1 }
          
          Write-Host "ğŸ”„ Äang cÃ i Ä‘áº·t Ngrok..."
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip
          .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          Write-Host "â³ Äang táº¡o Ä‘Æ°á»ng háº§m káº¿t ná»‘i (sá»­ dá»¥ng Start-Job)..."
          # FIX: Sá»­ dá»¥ng Start-Job Ä‘á»ƒ cháº¡y Ngrok á»Ÿ cháº¿ Ä‘á»™ ná»n á»•n Ä‘á»‹nh hÆ¡n
          Start-Job -ScriptBlock { .\ngrok\ngrok.exe tcp 3389 } | Out-Null
          
          # Chá» 10 giÃ¢y (Thá»i gian chá» tá»‘i Æ°u)
          Start-Sleep -Seconds 10 
          
          try {
              $tunnel = Invoke-RestMethod http://localhost:4040/api/tunnels
              $publicUrl = $tunnel.tunnels[0].public_url
              $address = $publicUrl -replace "tcp://", ""
              echo "SERVER_IP=$address" >> $env:GITHUB_ENV
              Write-Host "âœ… ÄÃ£ táº¡o IP thÃ nh cÃ´ng: $address" -ForegroundColor Green
          } catch {
              Write-Error "âŒ Lá»—i khÃ´ng thá»ƒ truy cáº­p API Ngrok. Vui lÃ²ng kiá»ƒm tra láº¡i Ngrok Token."
              exit 1
          }

      # 4. KÃCH HOáº T RDP
      - name: ğŸ”“ Má» KHÃ“A RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "âœ… ÄÃ£ má»Ÿ cá»•ng RDP." -ForegroundColor Green

      # 5. HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $durationInput = "${{ github.event.inputs.duration }}"
          if ($durationInput -match '\((\d+)m\)') { $minutes = [int]$matches[1] } else { $minutes = 60 }
          echo "MINUTES=$minutes" >> $env:GITHUB_ENV
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“" -ForegroundColor Magenta
          Write-Host "â”ƒ          ğŸ’– SERVER NGANCUTE IS READY      â”ƒ" -ForegroundColor Magenta
          Write-Host "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«" -ForegroundColor Magenta
          Write-Host "â”ƒ ğŸ”— IP Address:  $env:SERVER_IP" -ForegroundColor White
          Write-Host "â”ƒ ğŸ‘¤ Username:    ngancute" -ForegroundColor White
          Write-Host "â”ƒ ğŸ” Password:    $env:RDP_PASS" -ForegroundColor White
          Write-Host "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›" -ForegroundColor Magenta

      # 6. TREO MÃY (KEEP ALIVE)
      - name: â³ DUY TRÃŒ SERVER
        run: |
          $seconds = [int]$env:MINUTES * 60
          $end = (Get-Date).AddSeconds($seconds)
          
          while ((Get-Date) -lt $end) {
              $remaining = New-TimeSpan -Start (Get-Date) -End $end
              Write-Host "`rğŸ’“ Ngancute cÃ²n sá»‘ng: $($remaining.Hours):$($remaining.Minutes):$($remaining.Seconds) " -NoNewline -ForegroundColor Magenta
              Start-Sleep -Seconds 5
          }
          
